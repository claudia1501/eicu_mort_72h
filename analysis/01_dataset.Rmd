---
title: "01_dataset_creation"
author: "Claudia Jiménez"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
# output:
#   html_notebook:
#     code_folding: hide
#     number_sections: yes
#     theme: flatly
#     toc: yes
#     toc_float: yes
---

# Environment

```{r message=FALSE, warning=FALSE}
library(bigrquery)
library(DBI)
library(dplyr)
library(forcats)
library(summarytools)
```

# BigQuery related functions

This chunks creates the run_query and getSQL function.

```{r}
# Function that takes in a SQL command and runs it on BigQuery. This avoids the connection data in each iteration
run_query<-function(query){
  query_output<-dbGetQuery(con,query)
  return(query_output)
}

# Function for reading SQL files from a folder
getSQL <- function(filepath) {
  con = file(filepath, "r")
  sql.string <- ""
  while (TRUE) {
    line <- readLines(con, n = 1)
    if (length(line) == 0) {
      break
    }
    line <- gsub("\\t", " ", line)
    if (grepl("--", line) == TRUE) {
      line <- paste(sub("--", "/*", line), "*/")
    }
    sql.string <- paste(sql.string, line)
  }
  close(con)
  return(sql.string)
}
```

## Setting up connection

```{r}
bigrquery::bq_auth() # UNCOMMENT WHEN HAVEN TOCKEN ISSUES!!!
# Establecer la conexión a BigQuery
project_id <- readline(prompt = "Enter your project ID: ")

con <- dbConnect(
  bigrquery::bigquery(),
  project = project_id
)

```


# Data Extraction

Loading queries and extracting the data.

```{r}
## Demographics dates
basic_demographics <- run_query(getSQL("sql/basic_demographics.sql"))
pivoted_med <- run_query(getSQL("sql/pivoted_med.sql"))
labs_first_day <- run_query(getSQL("sql/labs_first_day.sql"))
vitals_first_day <- run_query(getSQL("sql/vitals_first_day.sql"))
icu_mortality_72hrs <- run_query(getSQL("sql/icu_mortality_72hrs.sql"))
apachescore <- run_query(getSQL("sql/apachescore.sql"))
apacheadmission <- run_query(getSQL("sql/apacheadmission.sql"))
prev_dept_los <- run_query(getSQL("sql/prev_dept_los.sql"))
clearance_pivoted_vitals <- run_query(getSQL("sql/clearance_pivoted_vitals.sql"))
clearance_pivoted_lab <- run_query(getSQL("sql/clearance_pivoted_lab.sql"))
clearance_pivoted_med <- run_query(getSQL("sql/clearance_pivoted_med.sql"))
```
# Joining dataframes

```{r}
# Define the data frames to join
dfs_to_join <- list(basic_demographics, labs_first_day, clearance_pivoted_vitals, icu_mortality_72hrs,apachescore, apacheadmission, prev_dept_los, clearance_pivoted_lab, clearance_pivoted_med)

# Perform the left join
final_df <- Reduce(function(x, y) merge(x, y, by = "patientunitstayid", all.x = TRUE), dfs_to_join)

```

## Creation of new variables and adjustment

```{r}
## Pass the variable character age to numeric. Replace >89 with 90.Rename variable gender (1 male, 2 female)

final_df <- final_df %>%
  mutate(
    age = ifelse(age == '> 89', 90,
                          ifelse(trimws(age) == '', NA_real_,
                                  as.numeric(age)))
  ) %>%
  mutate(
    gender = ifelse(
      gender == 2, "female",
      ifelse(
        gender == 1, "male", NA_character_
      )
    ) 
  ) %>%
  mutate(
    icu_mortality_72hrs = ifelse(
      icu_mortality_72hrs == 1, "Expired",
      ifelse(
        icu_mortality_72hrs == 0, "Alived", NA_character_
      )
    )
  )


```


# Imputation 1º
```{r}
#Delete NA values of variable gender (177)
final_df <- final_df %>%
 mutate(
   gender = as.factor(fct_explicit_na(gender, na_level = "Unknown"))) #NA values of gender are converted to "Unknown"
#change reference level of factor gender variable to "Male") 
final_df$gender <- relevel(final_df$gender,ref = "male")   

#Delete NA value of variable icu_mortality_72hrs
final_df <- final_df %>%
  mutate(icu_mortality_72hrs = coalesce(icu_mortality_72hrs, "Alived"))

#Delete NA values of variable age (6)
final_df <- final_df %>%
  filter(!is.na(age))

# Change NA value of variable apachescoreIV = median
final_df <- final_df %>%
  mutate(apachescoreIV = ifelse(is.na(apachescoreIV), median(apachescoreIV, na.rm = TRUE), apachescoreIV))

```

##Imputaciones 2º

###Imputacion dataframe labs_first_day
```{r}
#Replace NA with median df:labs_first_day
final_df <- final_df %>%
  mutate(
    aniongap_min = ifelse(is.na(aniongap_min), median(aniongap_min, na.rm = TRUE), aniongap_min),
    aniongap_max = ifelse(is.na(aniongap_max), median(aniongap_max, na.rm = TRUE), aniongap_max),
    albumin_min = ifelse(is.na(albumin_min), median(albumin_min, na.rm = TRUE), albumin_min),
    albumin_max = ifelse(is.na(albumin_max), median(albumin_max, na.rm = TRUE), albumin_max),
    bands_min = ifelse(is.na(bands_min), median(bands_min, na.rm = TRUE), bands_min),
    bands_max = ifelse(is.na(bands_max), median(bands_max, na.rm = TRUE), bands_max),
    bicarbonate_max = ifelse(is.na(bicarbonate_max), median(bicarbonate_max, na.rm = TRUE), bicarbonate_max),
    bicarbonate_min = ifelse(is.na(bicarbonate_min), median(bicarbonate_min, na.rm = TRUE), bicarbonate_min),
    hco3_min = ifelse(is.na(hco3_min), median(hco3_min, na.rm = TRUE), hco3_min),
    hco3_max = ifelse(is.na(hco3_max), median(hco3_max, na.rm = TRUE), hco3_max),
    bilirubin_min = ifelse(is.na(bilirubin_min), median(bilirubin_min, na.rm = TRUE), bilirubin_min),
    bilirubin_max = ifelse(is.na(bilirubin_max), median(bilirubin_max, na.rm = TRUE), bilirubin_max),
    creatinine_min = ifelse(is.na(creatinine_min), median(creatinine_min, na.rm = TRUE), creatinine_min),
    creatinine_max = ifelse(is.na(creatinine_max), median(creatinine_max, na.rm = TRUE), creatinine_max),
    chloride_min = ifelse(is.na(chloride_min), median(chloride_min, na.rm = TRUE), chloride_min),
    chloride_min = ifelse(is.na(chloride_min), median(chloride_min, na.rm = TRUE), chloride_min),
    chloride_max = ifelse(is.na(chloride_max), median(chloride_max, na.rm = TRUE), chloride_max),
    glucose_min = ifelse(is.na(glucose_min), median(glucose_min, na.rm = TRUE), glucose_min),
    glucose_max = ifelse(is.na(glucose_max), median(glucose_max, na.rm = TRUE), glucose_max),
    hematocrit_min = ifelse(is.na(hematocrit_min), median(hematocrit_min, na.rm = TRUE), hematocrit_min),
    hematocrit_max = ifelse(is.na(hematocrit_max), median(hematocrit_max, na.rm = TRUE), hematocrit_max),
    hemoglobin_min = ifelse(is.na(hemoglobin_min), median(hemoglobin_min, na.rm = TRUE), hemoglobin_min),
    hemoglobin_max = ifelse(is.na(hemoglobin_max), median(hemoglobin_max, na.rm = TRUE), hemoglobin_max),
    lactate_min = ifelse(is.na(lactate_min), median(lactate_min, na.rm = TRUE), lactate_min),
    lactate_max = ifelse(is.na(lactate_max), median(lactate_max, na.rm = TRUE), lactate_max),
    platelet_min = ifelse(is.na(platelet_min), median(platelet_min, na.rm = TRUE), platelet_min),
    platelet_max = ifelse(is.na(platelet_max), median(platelet_max, na.rm = TRUE), platelet_max),
    potassium_min = ifelse(is.na(potassium_min), median(potassium_min, na.rm = TRUE), potassium_min),
    potassium_max = ifelse(is.na(potassium_max), median(potassium_max, na.rm = TRUE), potassium_max),
    ptt_min = ifelse(is.na(ptt_min), median(ptt_min, na.rm = TRUE), ptt_min),
    ptt_max = ifelse(is.na(ptt_max), median(ptt_max, na.rm = TRUE), ptt_max),
    inr_min = ifelse(is.na(inr_min), median(inr_min, na.rm = TRUE), inr_min),
    inr_max = ifelse(is.na(inr_max), median(inr_max, na.rm = TRUE), inr_max),
    pt_min = ifelse(is.na(pt_min), median(pt_min, na.rm = TRUE), pt_min),
    pt_max = ifelse(is.na(pt_max), median(pt_max, na.rm = TRUE), pt_max),
    sodium_min = ifelse(is.na(sodium_min), median(sodium_min, na.rm = TRUE), sodium_min),
    sodium_max = ifelse(is.na(sodium_max), median(sodium_max, na.rm = TRUE), sodium_max),
    bun_min = ifelse(is.na(bun_min), median(bun_min, na.rm = TRUE), bun_min),
    bun_max = ifelse(is.na(bun_max), median(bun_max, na.rm = TRUE), bun_max),
    wbc_min = ifelse(is.na(wbc_min), median(wbc_min, na.rm = TRUE), wbc_min),
    wbc_max = ifelse(is.na(wbc_max), median(wbc_max, na.rm = TRUE), wbc_max)
  )

# Reemplaza 'tu_dataframe' con el nombre de tu dataframe en R
# Asegúrate de que las columnas sean numéricas o, de lo contrario, conviértelas antes de realizar los cálculos.

# Crear un nuevo dataframe con las diferencias
clearance_labs_first_day <- data.frame(patientunitstayid = final_df$patientunitstayid)

# Lista de las variables de interés
variables_of_interest <- c(
  "aniongap",
  "albumin",
  "bands",
  "bicarbonate",
  "hco3",
  "bilirubin",
  "creatinine",
  "chloride",
  "glucose",
  "hematocrit",
  "hemoglobin",
  "lactate",
  "platelet",
  "potassium",
  "ptt",
  "inr",
  "pt",
  "sodium",
  "bun",
  "wbc"
)

# Calcular las diferencias
for (var in variables_of_interest) {
  min_col <- paste(var, "min", sep = "_")
  max_col <- paste(var, "max", sep = "_")
  clearance_labs_first_day[[var]] <- final_df[[max_col]] - final_df[[min_col]]
}

```
###Imputacion dataframe clearance_pivoted_vitals
```{r}
#Replace NA with 0 df:vitals_firts_day
final_df <- final_df %>%
  mutate(
    heartrate_first = ifelse(is.na(heartrate_first), median(heartrate_first, na.rm = TRUE), heartrate_first),
    heartrate_last = ifelse(is.na(heartrate_last), median(heartrate_last, na.rm = TRUE), heartrate_last),
    respiratoryrate_first = ifelse(is.na(respiratoryrate_first), median(respiratoryrate_first, na.rm = TRUE), respiratoryrate_first),
    respiratoryrate_last = ifelse(is.na(respiratoryrate_last), median(respiratoryrate_last, na.rm = TRUE), respiratoryrate_last),
    spo2_first = ifelse(is.na(spo2_first), median(spo2_first, na.rm = TRUE), spo2_first),
    spo2_last = ifelse(is.na(spo2_last), median(spo2_last, na.rm = TRUE), spo2_last),
    nibp_systolic_first = ifelse(is.na(nibp_systolic_first), median(nibp_systolic_first, na.rm = TRUE), nibp_systolic_first),
    nibp_systolic_last = ifelse(is.na(nibp_systolic_last), median(nibp_systolic_last, na.rm = TRUE), nibp_systolic_last),
    nibp_diastolic_first = ifelse(is.na(nibp_diastolic_first), median(nibp_diastolic_first, na.rm = TRUE), nibp_diastolic_first),
    nibp_diastolic_last = ifelse(is.na(nibp_diastolic_last), median(nibp_diastolic_last, na.rm = TRUE), nibp_diastolic_last),
    nibp_mean_first = ifelse(is.na(nibp_mean_first), median(nibp_mean_first, na.rm = TRUE), nibp_mean_first),
    nibp_mean_last = ifelse(is.na(nibp_mean_last), median(nibp_mean_last, na.rm = TRUE), nibp_mean_last),
    temperature_first = ifelse(is.na(temperature_first), median(temperature_first, na.rm = TRUE), temperature_first),
    temperature_last = ifelse(is.na(temperature_last), median(temperature_last, na.rm = TRUE), temperature_last),
    temperaturelocation_first = ifelse(is.na(temperaturelocation_first), median(temperaturelocation_first, na.rm = TRUE), temperaturelocation_first),
    temperaturelocation_last = ifelse(is.na(temperaturelocation_last), median(temperaturelocation_last, na.rm = TRUE), temperaturelocation_last),
    ibp_systolic_first = ifelse(is.na(ibp_systolic_first), median(ibp_systolic_first, na.rm = TRUE), ibp_systolic_first),
    ibp_systolic_last = ifelse(is.na(ibp_systolic_last), median(ibp_systolic_last, na.rm = TRUE), ibp_systolic_last),
    ibp_diastolic_first = ifelse(is.na(ibp_diastolic_first), median(ibp_diastolic_first, na.rm = TRUE), ibp_diastolic_first),
    ibp_diastolic_last = ifelse(is.na(ibp_diastolic_last), median(ibp_diastolic_last, na.rm = TRUE), ibp_diastolic_last),
    ibp_mean_first = ifelse(is.na(ibp_mean_first), median(ibp_mean_first, na.rm = TRUE), ibp_mean_first),
    ibp_mean_last = ifelse(is.na(ibp_mean_last), median(ibp_mean_last, na.rm = TRUE), ibp_mean_last)
  )

# Lista de las variables de interés
variables_of_interest <- c(
  "heartrate",
  "respiratoryrate",
  "spo2",
  "nibp_systolic",
  "nibp_diastolic",
  "nibp_mean",
  "temperature",
  "temperaturelocation",
  "ibp_systolic",
  "ibp_diastolic",
  "ibp_mean"
)

# Crear un nuevo DataFrame para almacenar las diferencias
clearance_pivoted_vitals_d <- data.frame(patientunitstayid = final_df$patientunitstayid)

# Calcular las diferencias
for (var in variables_of_interest) {
  min_col <- paste(var, "first", sep = "_")
  max_col <- paste(var, "last", sep = "_")
  clearance_pivoted_vitals_d[[var]] <- final_df[[max_col]] - final_df[[min_col]]
}
```
###Imputacion dataframe clearance_pivoted_med
```{r}
# Lista de las variables de interés
variables_of_interest <- c(
  "norepinephrine",
  "epinephrine",
  "dopamine",
  "dobutamine",
  "phenylephrine",
  "vasopressin",
  "milrinone",
  "heparin",
  "warfarin"
)

# Crear un nuevo DataFrame para almacenar las diferencias
clearance_pivoted_meds_d <- data.frame(patientunitstayid = final_df$patientunitstayid)

# Calcular las diferencias
for (var in variables_of_interest) {
  first_col <- paste(var, "first", sep = "_")
  last_col <- paste(var, "last", sep = "_")
  clearance_pivoted_meds_d[[var]] <- final_df[[last_col]] - final_df[[first_col]]
}

```

###Imputacion dataframe clearance_pivoted_lab
```{r}
final_df <- final_df %>%
  mutate(
    albumin_first = ifelse(is.na(albumin_first), median(albumin_first, na.rm = TRUE), albumin_first),
    albumin_last = ifelse(is.na(albumin_last), median(albumin_last, na.rm = TRUE), albumin_last),
    bilirubin_first = ifelse(is.na(bilirubin_first), median(bilirubin_first, na.rm = TRUE), bilirubin_first),
    bilirubin_last = ifelse(is.na(bilirubin_last), median(bilirubin_last, na.rm = TRUE), bilirubin_last),
    BUN_first = ifelse(is.na(BUN_first), median(BUN_first, na.rm = TRUE), BUN_first),
    BUN_last = ifelse(is.na(BUN_last), median(BUN_last, na.rm = TRUE), BUN_last),
    calcium_first = ifelse(is.na(calcium_first), median(calcium_first, na.rm = TRUE), calcium_first),
    calcium_last = ifelse(is.na(calcium_last), median(calcium_last, na.rm = TRUE), calcium_last),
    creatinine_first = ifelse(is.na(creatinine_first), median(creatinine_first, na.rm = TRUE), creatinine_first),
    creatinine_last = ifelse(is.na(creatinine_last), median(creatinine_last, na.rm = TRUE), creatinine_last),
    glucose_first = ifelse(is.na(glucose_first), median(glucose_first, na.rm = TRUE), glucose_first),
    glucose_last = ifelse(is.na(glucose_last), median(glucose_last, na.rm = TRUE), glucose_last),
    bicarbonate_first = ifelse(is.na(bicarbonate_first), median(bicarbonate_first, na.rm = TRUE), bicarbonate_first),
    bicarbonate_last = ifelse(is.na(bicarbonate_last), median(bicarbonate_last, na.rm = TRUE), bicarbonate_last),
    TotalCO2_first = ifelse(is.na(TotalCO2_first), median(TotalCO2_first, na.rm = TRUE), TotalCO2_first),
    TotalCO2_last = ifelse(is.na(TotalCO2_last), median(TotalCO2_last, na.rm = TRUE), TotalCO2_last),
    hematocrit_first = ifelse(is.na(hematocrit_first), median(hematocrit_first, na.rm = TRUE), hematocrit_first),
    hematocrit_last = ifelse(is.na(hematocrit_last), median(hematocrit_last, na.rm = TRUE), hematocrit_last),
    hemoglobin_first = ifelse(is.na(hemoglobin_first), median(hemoglobin_first, na.rm = TRUE), hemoglobin_first),
    hemoglobin_last = ifelse(is.na(hemoglobin_last), median(hemoglobin_last, na.rm = TRUE), hemoglobin_last),
    INR_first = ifelse(is.na(INR_first), median(INR_first, na.rm = TRUE), INR_first),
    INR_last = ifelse(is.na(INR_last), median(INR_last, na.rm = TRUE), INR_last),
    lactate_first = ifelse(is.na(lactate_first), median(lactate_first, na.rm = TRUE), lactate_first),
    lactate_last = ifelse(is.na(lactate_last), median(lactate_last, na.rm = TRUE), lactate_last),
    platelets_first = ifelse(is.na(platelets_first), median(platelets_first, na.rm = TRUE), platelets_first),
    platelets_last = ifelse(is.na(platelets_last), median(platelets_last, na.rm = TRUE), platelets_last),
    potassium_first = ifelse(is.na(potassium_first), median(potassium_first, na.rm = TRUE), potassium_first),
    potassium_last = ifelse(is.na(potassium_last), median(potassium_last, na.rm = TRUE), potassium_last),
    ptt_first = ifelse(is.na(ptt_first), median(ptt_first, na.rm = TRUE), ptt_first),
    ptt_last = ifelse(is.na(ptt_last), median(ptt_last, na.rm = TRUE), ptt_last),
    sodium_first = ifelse(is.na(sodium_first), median(sodium_first, na.rm = TRUE), sodium_first),
    sodium_last = ifelse(is.na(sodium_last), median(sodium_last, na.rm = TRUE), sodium_last),
    wbc_first = ifelse(is.na(wbc_first), median(wbc_first, na.rm = TRUE), wbc_first),
    wbc_last = ifelse(is.na(wbc_last), median(wbc_last, na.rm = TRUE), wbc_last),
    bands_first = ifelse(is.na(bands_first), median(bands_first, na.rm = TRUE), bands_first),
    bands_last = ifelse(is.na(bands_last), median(bands_last, na.rm = TRUE), bands_last),
    alt_first = ifelse(is.na(alt_first), median(alt_first, na.rm = TRUE), alt_first),
    alt_last = ifelse(is.na(alt_last), median(alt_last, na.rm = TRUE), alt_last),
    ast_first = ifelse(is.na(ast_first), median(ast_first, na.rm = TRUE), ast_first),
    ast_last = ifelse(is.na(ast_last), median(ast_last, na.rm = TRUE), ast_last),
    alp_first = ifelse(is.na(alp_first), median(alp_first, na.rm = TRUE), alp_first),
    alp_last = ifelse(is.na(alp_last), median(alp_last, na.rm = TRUE), alp_last)
  )

# Lista de las variables de interés
variables_of_interest <- c(
  "aniongap",
  "albumin",
  "bilirubin",
  "BUN",
  "calcium",
  "creatinine",
  "glucose",
  "bicarbonate",
  "TotalCO2",
  "hematocrit",
  "hemoglobin",
  "INR",
  "lactate",
  "platelets",
  "potassium",
  "ptt",
  "sodium",
  "wbc",
  "bands",
  "alt",
  "ast",
  "alp"
)

# Crear un nuevo DataFrame para almacenar las diferencias
clearance_pivoted_lab_d <- data.frame(patientunitstayid = final_df$patientunitstayid)

# Calcular las diferencias
for (var in variables_of_interest) {
  first_col <- paste(var, "first", sep = "_")
  last_col <- paste(var, "last", sep = "_")
  clearance_pivoted_lab_d[[var]] <- final_df[[last_col]] - final_df[[first_col]]
}

```


# Posibles Imputaciones
```{r}
#Replace NA with 0 df:pivoted_med
final_df <- final_df %>%
  mutate(
    norepinephrine_mean = coalesce(norepinephrine_mean, 0),
    norepinephrine_max = coalesce(norepinephrine_max, 0),
    norepinephrine_min = coalesce(norepinephrine_min, 0),
    epinephrine_mean = coalesce(epinephrine_mean, 0),
    epinephrine_max = coalesce(epinephrine_max, 0),
    epinephrine_min = coalesce(epinephrine_min, 0),
    dopamine_mean = coalesce(dopamine_mean, 0),
    dopamine_max = coalesce(dopamine_max, 0),
    dopamine_min = coalesce(dopamine_min, 0),
    dobutamine_mean = coalesce(dobutamine_mean, 0),
    dobutamine_max = coalesce(dobutamine_max, 0),
    dobutamine_min = coalesce(dobutamine_min, 0),
    phenylephrine_mean = coalesce(phenylephrine_mean, 0),
    phenylephrine_max = coalesce(phenylephrine_max, 0),
    phenylephrine_min = coalesce(phenylephrine_min, 0),
    vasopressin_mean = coalesce(vasopressin_mean, 0),
    vasopressin_max = coalesce(vasopressin_max, 0),
    vasopressin_min = coalesce(vasopressin_min, 0),
    milrinone_mean = coalesce(milrinone_mean, 0),
    milrinone_max = coalesce(milrinone_max, 0),
    milrinone_min = coalesce(milrinone_min, 0),
    heparin_mean = coalesce(heparin_mean, 0),
    heparin_max = coalesce(heparin_max, 0),
    heparin_min = coalesce(heparin_min, 0),
    warfarin_mean = coalesce(warfarin_mean, 0),
    warfarin_max = coalesce(warfarin_max, 0),
    warfarin_min = coalesce(warfarin_min, 0)
  )




```

# Order variables
```{r}
final_df_order <- final_df %>%
  select(patientunitstayid,age_numeric,gender,icu_mortality_72hrs,apachescoreIV,apachedxgroup,prev_dept_los,prev_dept,norepinephrine_mean, norepinephrine_max, norepinephrine_min, epinephrine_mean, epinephrine_max, epinephrine_min, dopamine_mean, dopamine_max, dopamine_min, dobutamine_mean, dobutamine_max, dobutamine_min, phenylephrine_mean, phenylephrine_max, phenylephrine_min, vasopressin_mean, vasopressin_max, vasopressin_min, milrinone_mean, milrinone_max, milrinone_min, heparin_mean, heparin_max, heparin_min, warfarin_mean, warfarin_max, warfarin_min,aniongap_min,aniongap_max,albumin_min,albumin_max,bands_min,bands_max,bicarbonate_min,bicarbonate_max,hco3_min,hco3_max,bilirubin_min,bilirubin_max,creatinine_min,creatinine_max,chloride_min,chloride_max,glucose_min,glucose_max,hematocrit_min,hematocrit_max,hemoglobin_min,hemoglobin_max,lactate_min,lactate_max,platelet_min,platelet_max,potassium_min,potassium_max,ptt_min,ptt_max,inr_min,inr_max,pt_min,pt_max,sodium_min,sodium_max,bun_min,bun_max,wbc_min,wbc_max,heartrate_first, heartrate_last, respiratoryrate_first, respiratoryrate_last, spo2_first, spo2_last,nibp_systolic_first, nibp_systolic_last, nibp_diastolic_first, nibp_diastolic_last, nibp_mean_first,nibp_mean_last, temperature_first, temperature_last, temperaturelocation_first, temperaturelocation_last, 
ibp_systolic_first, ibp_systolic_last, ibp_diastolic_first, ibp_diastolic_last, ibp_mean_first, ibp_mean_last
)
```



# Exclusion criteria



```{r}
print('Initial number of patients')
exc_1<-nrow(final_df_order)
exc_1

final_df_selected <- final_df_order %>% filter(age_numeric > 16)
print('Underage patients excluded')
b<-nrow(final_df_selected)
a-b

print('Número final de pacientes')
nrow(final_df_selected)
```

## diagram
