---
title: "01_dataset_creation"
author: "Claudia Jiménez"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  html_notebook:
    code_folding: hide
    number_sections: yes
    theme: flatly
    toc: yes
    toc_float: yes
---

# Environment

```{r message=FALSE, warning=FALSE}
library(bigrquery)
library(DBI)
library(dplyr)
```

# BigQuery related functions

This chunks creates the run_query and getSQL function.

```{r}
# Function that takes in a SQL command and runs it on BigQuery. This avoids the connection data in each iteration
run_query<-function(query){
  query_output<-dbGetQuery(con,query)
  return(query_output)
}

# Function for reading SQL files from a folder
getSQL <- function(filepath) {
  con = file(filepath, "r")
  sql.string <- ""
  while (TRUE) {
    line <- readLines(con, n = 1)
    if (length(line) == 0) {
      break
    }
    line <- gsub("\\t", " ", line)
    if (grepl("--", line) == TRUE) {
      line <- paste(sub("--", "/*", line), "*/")
    }
    sql.string <- paste(sql.string, line)
  }
  close(con)
  return(sql.string)
}
```

## Setting up connection

```{r}
# Establecer la conexión a BigQuery
project_id <- readline(prompt = "Enter your project ID: ")

con <- dbConnect(
  bigrquery::bigquery(),
  project = project_id
)

```


# Data Extraction

Loading queries and extracting the data.

```{r}
## Demographics dates
basic_demographics <- run_query(getSQL("sql/basic_demographics.sql"))
pivoted_med_first_day <- run_query(getSQL("sql/pivoted_med_first_day.sql"))
labs_first_day <- run_query(getSQL("sql/labs_first_day.sql"))
vitals_first_day <- run_query(getSQL("sql/vitals_first_day.sql"))
```

# Joining dataframes

```{r}
# Define the data frames to join
dfs_to_join <- list(basic_demographics, pivoted_med_first_day, labs_first_day, vitals_first_day)

# Perform the left join
final_df <- Reduce(function(x, y) merge(x, y, by = "patientunitstayid", all.x = TRUE), dfs_to_join)

```

# Exclusion criteria

```{r}
print('Initial number of patients')
a<-nrow(final_df)
a

estudio_vacunas_final_selected<-estudio_vacunas_final%>%filter(pautas_covid <5 )
print('Underage patients excluded')
b<-nrow(estudio_vacunas_final_selected)
a-b

print('Número final de pacientes')
nrow(estudio_vacunas_final_selected)
```






















