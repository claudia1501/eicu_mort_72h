---
title: "01_dataset_creation"
author: "Claudia Jiménez"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
# output:
#   html_notebook:
#     code_folding: hide
#     number_sections: yes
#     theme: flatly
#     toc: yes
#     toc_float: yes
---

# Environment

```{r message=FALSE, warning=FALSE}
library(bigrquery)
library(DBI)
library(dplyr)
library(forcats)
library(summarytools)
```

# BigQuery related functions

This chunks creates the run_query and getSQL function.

```{r}
# Function that takes in a SQL command and runs it on BigQuery. This avoids the connection data in each iteration
run_query<-function(query){
  query_output<-dbGetQuery(con,query)
  return(query_output)
}

# Function for reading SQL files from a folder
getSQL <- function(filepath) {
  con = file(filepath, "r")
  sql.string <- ""
  while (TRUE) {
    line <- readLines(con, n = 1)
    if (length(line) == 0) {
      break
    }
    line <- gsub("\\t", " ", line)
    if (grepl("--", line) == TRUE) {
      line <- paste(sub("--", "/*", line), "*/")
    }
    sql.string <- paste(sql.string, line)
  }
  close(con)
  return(sql.string)
}
```

## Setting up connection

```{r}
bigrquery::bq_auth() # UNCOMMENT WHEN HAVEN TOCKEN ISSUES!!!
# Establecer la conexión a BigQuery
project_id <- readline(prompt = "Enter your project ID: ")

con <- dbConnect(
  bigrquery::bigquery(),
  project = project_id
)

```


# Data Extraction

Loading queries and extracting the data.

```{r}
## Demographics dates
basic_demographics <- run_query(getSQL("sql/basic_demographics.sql"))
icu_mortality_72hrs <- run_query(getSQL("sql/icu_mortality_72hrs.sql"))
apachescore <- run_query(getSQL("sql/apachescore.sql"))
apacheadmission <- run_query(getSQL("sql/apacheadmission.sql"))
prev_dept_los <- run_query(getSQL("sql/prev_dept_los.sql"))
clearance_pivoted_vitals <- run_query(getSQL("sql/clearance_pivoted_vitals.sql"))
clearance_pivoted_lab <- run_query(getSQL("sql/clearance_pivoted_lab.sql"))
clearance_pivoted_med <- run_query(getSQL("sql/clearance_pivoted_med.sql"))
```

#Imputation: 1º part
##Imputation dataframe clearance_pivoted_vitals
```{r}
#Replace NA with 0 df: clearance_pivoted_vitals
clearance_piv_vitals <- clearance_pivoted_vitals %>%
  mutate(
    heartrate_first = ifelse(is.na(heartrate_first), median(heartrate_first, na.rm = TRUE), heartrate_first),
    heartrate_last = ifelse(is.na(heartrate_last), median(heartrate_last, na.rm = TRUE), heartrate_last),
    respiratoryrate_first = ifelse(is.na(respiratoryrate_first), median(respiratoryrate_first, na.rm = TRUE), respiratoryrate_first),
    respiratoryrate_last = ifelse(is.na(respiratoryrate_last), median(respiratoryrate_last, na.rm = TRUE), respiratoryrate_last),
    spo2_first = ifelse(is.na(spo2_first), median(spo2_first, na.rm = TRUE), spo2_first),
    spo2_last = ifelse(is.na(spo2_last), median(spo2_last, na.rm = TRUE), spo2_last),
    nibp_systolic_first = ifelse(is.na(nibp_systolic_first), median(nibp_systolic_first, na.rm = TRUE), nibp_systolic_first),
    nibp_systolic_last = ifelse(is.na(nibp_systolic_last), median(nibp_systolic_last, na.rm = TRUE), nibp_systolic_last),
    nibp_diastolic_first = ifelse(is.na(nibp_diastolic_first), median(nibp_diastolic_first, na.rm = TRUE), nibp_diastolic_first),
    nibp_diastolic_last = ifelse(is.na(nibp_diastolic_last), median(nibp_diastolic_last, na.rm = TRUE), nibp_diastolic_last),
    nibp_mean_first = ifelse(is.na(nibp_mean_first), median(nibp_mean_first, na.rm = TRUE), nibp_mean_first),
    nibp_mean_last = ifelse(is.na(nibp_mean_last), median(nibp_mean_last, na.rm = TRUE), nibp_mean_last),
    temperature_first = ifelse(is.na(temperature_first), median(temperature_first, na.rm = TRUE), temperature_first),
    temperature_last = ifelse(is.na(temperature_last), median(temperature_last, na.rm = TRUE), temperature_last),
    ibp_systolic_first = ifelse(is.na(ibp_systolic_first), median(ibp_systolic_first, na.rm = TRUE), ibp_systolic_first),
    ibp_systolic_last = ifelse(is.na(ibp_systolic_last), median(ibp_systolic_last, na.rm = TRUE), ibp_systolic_last),
    ibp_diastolic_first = ifelse(is.na(ibp_diastolic_first), median(ibp_diastolic_first, na.rm = TRUE), ibp_diastolic_first),
    ibp_diastolic_last = ifelse(is.na(ibp_diastolic_last), median(ibp_diastolic_last, na.rm = TRUE), ibp_diastolic_last),
    ibp_mean_first = ifelse(is.na(ibp_mean_first), median(ibp_mean_first, na.rm = TRUE), ibp_mean_first),
    ibp_mean_last = ifelse(is.na(ibp_mean_last), median(ibp_mean_last, na.rm = TRUE), ibp_mean_last)
  )

# Lista de las variables de interés
variables_of_interest <- c(
  "heartrate",
  "respiratoryrate",
  "spo2",
  "nibp_systolic",
  "nibp_diastolic",
  "nibp_mean",
  "temperature",
  "ibp_systolic",
  "ibp_diastolic",
  "ibp_mean"
)

# Crear un nuevo DataFrame para almacenar las diferencias
clearance_pivoted_vitals_d <- data.frame(patientunitstayid = clearance_piv_vitals$patientunitstayid)

# Calcular las diferencias
for (var in variables_of_interest) {
  min_col <- paste(var, "first", sep = "_")
  max_col <- paste(var, "last", sep = "_")
  # Comprobar y convertir a numérico si es necesario
  clearance_pivoted_vitals_d[[var]] <- as.numeric(clearance_piv_vitals[[max_col]]) - as.numeric(clearance_piv_vitals[[min_col]])
}

```
##Imputation dataframe clearance_pivoted_lab
```{r}
clearance_piv_lab <- clearance_pivoted_lab %>%
  mutate(
    albumin_first = ifelse(is.na(albumin_first), median(albumin_first, na.rm = TRUE), albumin_first),
    albumin_last = ifelse(is.na(albumin_last), median(albumin_last, na.rm = TRUE), albumin_last),
    bilirubin_first = ifelse(is.na(bilirubin_first), median(bilirubin_first, na.rm = TRUE), bilirubin_first),
    bilirubin_last = ifelse(is.na(bilirubin_last), median(bilirubin_last, na.rm = TRUE), bilirubin_last),
    BUN_first = ifelse(is.na(BUN_first), median(BUN_first, na.rm = TRUE), BUN_first),
    BUN_last = ifelse(is.na(BUN_last), median(BUN_last, na.rm = TRUE), BUN_last),
    calcium_first = ifelse(is.na(calcium_first), median(calcium_first, na.rm = TRUE), calcium_first),
    calcium_last = ifelse(is.na(calcium_last), median(calcium_last, na.rm = TRUE), calcium_last),
    creatinine_first = ifelse(is.na(creatinine_first), median(creatinine_first, na.rm = TRUE), creatinine_first),
    creatinine_last = ifelse(is.na(creatinine_last), median(creatinine_last, na.rm = TRUE), creatinine_last),
    glucose_first = ifelse(is.na(glucose_first), median(glucose_first, na.rm = TRUE), glucose_first),
    glucose_last = ifelse(is.na(glucose_last), median(glucose_last, na.rm = TRUE), glucose_last),
    bicarbonate_first = ifelse(is.na(bicarbonate_first), median(bicarbonate_first, na.rm = TRUE), bicarbonate_first),
    bicarbonate_last = ifelse(is.na(bicarbonate_last), median(bicarbonate_last, na.rm = TRUE), bicarbonate_last),
    TotalCO2_first = ifelse(is.na(TotalCO2_first), median(TotalCO2_first, na.rm = TRUE), TotalCO2_first),
    TotalCO2_last = ifelse(is.na(TotalCO2_last), median(TotalCO2_last, na.rm = TRUE), TotalCO2_last),
    hematocrit_first = ifelse(is.na(hematocrit_first), median(hematocrit_first, na.rm = TRUE), hematocrit_first),
    hematocrit_last = ifelse(is.na(hematocrit_last), median(hematocrit_last, na.rm = TRUE), hematocrit_last),
    hemoglobin_first = ifelse(is.na(hemoglobin_first), median(hemoglobin_first, na.rm = TRUE), hemoglobin_first),
    hemoglobin_last = ifelse(is.na(hemoglobin_last), median(hemoglobin_last, na.rm = TRUE), hemoglobin_last),
    INR_first = ifelse(is.na(INR_first), median(INR_first, na.rm = TRUE), INR_first),
    INR_last = ifelse(is.na(INR_last), median(INR_last, na.rm = TRUE), INR_last),
    lactate_first = ifelse(is.na(lactate_first), median(lactate_first, na.rm = TRUE), lactate_first),
    lactate_last = ifelse(is.na(lactate_last), median(lactate_last, na.rm = TRUE), lactate_last),
    platelets_first = ifelse(is.na(platelets_first), median(platelets_first, na.rm = TRUE), platelets_first),
    platelets_last = ifelse(is.na(platelets_last), median(platelets_last, na.rm = TRUE), platelets_last),
    potassium_first = ifelse(is.na(potassium_first), median(potassium_first, na.rm = TRUE), potassium_first),
    potassium_last = ifelse(is.na(potassium_last), median(potassium_last, na.rm = TRUE), potassium_last),
    ptt_first = ifelse(is.na(ptt_first), median(ptt_first, na.rm = TRUE), ptt_first),
    ptt_last = ifelse(is.na(ptt_last), median(ptt_last, na.rm = TRUE), ptt_last),
    sodium_first = ifelse(is.na(sodium_first), median(sodium_first, na.rm = TRUE), sodium_first),
    sodium_last = ifelse(is.na(sodium_last), median(sodium_last, na.rm = TRUE), sodium_last),
    wbc_first = ifelse(is.na(wbc_first), median(wbc_first, na.rm = TRUE), wbc_first),
    wbc_last = ifelse(is.na(wbc_last), median(wbc_last, na.rm = TRUE), wbc_last),
    bands_first = ifelse(is.na(bands_first), median(bands_first, na.rm = TRUE), bands_first),
    bands_last = ifelse(is.na(bands_last), median(bands_last, na.rm = TRUE), bands_last),
    alt_first = ifelse(is.na(alt_first), median(alt_first, na.rm = TRUE), alt_first),
    alt_last = ifelse(is.na(alt_last), median(alt_last, na.rm = TRUE), alt_last),
    ast_first = ifelse(is.na(ast_first), median(ast_first, na.rm = TRUE), ast_first),
    ast_last = ifelse(is.na(ast_last), median(ast_last, na.rm = TRUE), ast_last),
    alp_first = ifelse(is.na(alp_first), median(alp_first, na.rm = TRUE), alp_first),
    alp_last = ifelse(is.na(alp_last), median(alp_last, na.rm = TRUE), alp_last)
  )

# Lista de las variables de interés
variables_of_interest <- c(
  "albumin",
  "bilirubin",
  "BUN",
  "calcium",
  "creatinine",
  "glucose",
  "bicarbonate",
  "TotalCO2",
  "hematocrit",
  "hemoglobin",
  "INR",
  "lactate",
  "platelets",
  "potassium",
  "ptt",
  "sodium",
  "wbc",
  "bands",
  "alt",
  "ast",
  "alp"
)

# Crear un nuevo DataFrame para almacenar las diferencias
clearance_pivoted_lab_d <- data.frame(patientunitstayid = clearance_piv_lab$patientunitstayid)

# Calcular las diferencias
for (var in variables_of_interest) {
  first_col <- paste(var, "first", sep = "_")
  last_col <- paste(var, "last", sep = "_")
  clearance_pivoted_lab_d[[var]] <- clearance_piv_lab[[last_col]] - clearance_piv_lab[[first_col]]
}

```

# Joining dataframes

```{r}
# Define the data frames to join
dfs_to_join <- list(basic_demographics, clearance_pivoted_vitals_d, icu_mortality_72hrs,apachescore, apacheadmission, prev_dept_los, clearance_pivoted_lab_d, clearance_pivoted_med)

# Perform the left join
final_df <- Reduce(function(x, y) merge(x, y, by = "patientunitstayid", all.x = TRUE), dfs_to_join)

```

## Creation of new variables and adjustment

```{r}
## Pass the variable character age to numeric. Replace >89 with 90.Rename variable gender (1 male, 2 female)

final_df <- final_df %>%
  mutate(
    age = ifelse(age == '> 89', 90,
                          ifelse(trimws(age) == '', NA_real_,
                                  as.numeric(age)))
  ) %>%
  mutate(
    gender = ifelse(
      gender == 2, "female",
      ifelse(
        gender == 1, "male", NA_character_
      )
    ) 
  ) %>%
  mutate(
    icu_mortality_72hrs = ifelse(
      icu_mortality_72hrs == 1, "Expired",
      ifelse(
        icu_mortality_72hrs == 0, "Alived", NA_character_
      )
    )
  )


```
#Imputation 2º part
```{r}
#Delete NA values of variable gender (177)
final_df <- final_df %>%
 mutate(
   gender = as.factor(fct_explicit_na(gender, na_level = "Unknown"))) #NA values of gender are converted to "Unknown"
#change reference level of factor gender variable to "Male") 
final_df$gender <- relevel(final_df$gender,ref = "male")
# Filtrar las filas donde gender no sea "Unknown"
final_df <- final_df %>% filter(gender != "Unknown")

#Delete NA value of variable icu_mortality_72hrs
final_df <- final_df %>%
  mutate(icu_mortality_72hrs = coalesce(icu_mortality_72hrs, "Alived"))

#Delete NA values of variable age (6)
final_df <- final_df %>%
  filter(!is.na(age))

# Change NA value of variable apachescoreIV = median
final_df <- final_df %>%
  mutate(apachescoreIV = ifelse(is.na(apachescoreIV), median(apachescoreIV, na.rm = TRUE), apachescoreIV))

```
##Imputation NA variable clearance_pivoted_lab_d
```{r}
final_df <- final_df %>%
  mutate(
    albumin = ifelse(is.na(albumin), median(albumin, na.rm = TRUE), albumin),
    bilirubin = ifelse(is.na(bilirubin), median(bilirubin, na.rm = TRUE), bilirubin),
    BUN = ifelse(is.na(BUN), median(BUN, na.rm = TRUE), BUN),
    calcium = ifelse(is.na(calcium), median(calcium, na.rm = TRUE), calcium),
    creatinine = ifelse(is.na(creatinine), median(creatinine, na.rm = TRUE), creatinine),
    glucose = ifelse(is.na(glucose), median(glucose, na.rm = TRUE), glucose),
    bicarbonate = ifelse(is.na(bicarbonate), median(bicarbonate, na.rm = TRUE), bicarbonate),
    TotalCO2 = ifelse(is.na(TotalCO2), median(TotalCO2, na.rm = TRUE), TotalCO2),
    hematocrit = ifelse(is.na(hematocrit), median(hematocrit, na.rm = TRUE), hematocrit),
    hemoglobin = ifelse(is.na(hemoglobin), median(hemoglobin, na.rm = TRUE), hemoglobin),
    INR = ifelse(is.na(INR), median(INR, na.rm = TRUE), INR),
    lactate = ifelse(is.na(lactate), median(lactate, na.rm = TRUE), lactate),
    platelets = ifelse(is.na(platelets), median(platelets, na.rm = TRUE), platelets),
    potassium = ifelse(is.na(potassium), median(potassium, na.rm = TRUE), potassium),
    ptt = ifelse(is.na(ptt), median(ptt, na.rm = TRUE), ptt),
    sodium = ifelse(is.na(sodium), median(sodium, na.rm = TRUE), sodium),
    wbc = ifelse(is.na(wbc), median(wbc, na.rm = TRUE), wbc),
    bands = ifelse(is.na(bands), median(bands, na.rm = TRUE), bands),
    alt = ifelse(is.na(alt), median(alt, na.rm = TRUE), alt),
    ast = ifelse(is.na(ast), median(ast, na.rm = TRUE), ast),
    alp = ifelse(is.na(alp), median(alp, na.rm = TRUE), alp)
  )
```
##Imputation NA variable clearance_pivoted_vitals_d
```{r}
final_df <- final_df %>%
  mutate(
    heartrate = ifelse(is.na(heartrate), median(heartrate, na.rm = TRUE), heartrate),
    respiratoryrate = ifelse(is.na(respiratoryrate), median(respiratoryrate, na.rm = TRUE), respiratoryrate),
    spo2 = ifelse(is.na(spo2), median(spo2, na.rm = TRUE), spo2),
    nibp_systolic = ifelse(is.na(nibp_systolic), median(nibp_systolic, na.rm = TRUE), nibp_systolic),
    nibp_diastolic = ifelse(is.na(nibp_diastolic), median(nibp_diastolic, na.rm = TRUE), nibp_diastolic),
    nibp_mean = ifelse(is.na(nibp_mean), median(nibp_mean, na.rm = TRUE), nibp_mean),
    temperature = ifelse(is.na(temperature), median(temperature, na.rm = TRUE), temperature),
    ibp_systolic = ifelse(is.na(ibp_systolic), median(ibp_systolic, na.rm = TRUE), ibp_systolic),
    ibp_diastolic = ifelse(is.na(ibp_diastolic), median(ibp_diastolic, na.rm = TRUE), ibp_diastolic),
    ibp_mean = ifelse(is.na(ibp_mean), median(ibp_mean, na.rm = TRUE), ibp_mean)
  )
```
##Imputation NA variable cleara
```{r}
#Replace NA with 0 df:pivoted_med
final_df <- final_df %>%
mutate(
norepinephrine_first = coalesce(norepinephrine_first, 0),
norepinephrine_last = coalesce(norepinephrine_last, 0),
epinephrine_first = coalesce(epinephrine_first, 0),
epinephrine_last = coalesce(epinephrine_last, 0),
dopamine_first = coalesce(dopamine_first, 0),
dopamine_last = coalesce(dopamine_last, 0),
dobutamine_first = coalesce(dobutamine_first, 0),
dobutamine_last = coalesce(dobutamine_last, 0),
phenylephrine_first = coalesce(phenylephrine_first, 0),
phenylephrine_last = coalesce(phenylephrine_last, 0),
vasopressin_first = coalesce(vasopressin_first, 0),
vasopressin_last = coalesce(vasopressin_last, 0),
milrinone_first = coalesce(milrinone_first, 0),
milrinone_last = coalesce(milrinone_last, 0),
heparin_first = coalesce(heparin_first, 0),
heparin_last = coalesce(heparin_last, 0),
warfarin_first = coalesce(warfarin_first, 0),
warfarin_last = coalesce(warfarin_last, 0)
)
```


# Order variables
```{r}
final_df_order <- final_df %>%
  select(patientunitstayid,age,gender,icu_mortality_72hrs,apachescoreIV,apachedxgroup,prev_dept_los,prev_dept,albumin,bilirubin,BUN,calcium,creatinine,glucose,bicarbonate,TotalCO2,hematocrit,hemoglobin,INR,lactate,platelets,potassium,ptt,sodium,wbc,bands,alt,ast,alp,heartrate,respiratoryrate,spo2,nibp_systolic,nibp_diastolic,nibp_mean,temperature,ibp_systolic,ibp_diastolic,ibp_mean,norepinephrine_first, norepinephrine_last,epinephrine_first,epinephrine_last,dopamine_first,dopamine_last,dobutamine_first,dobutamine_last,phenylephrine_first,phenylephrine_last,vasopressin_first,vasopressin_last,milrinone_first,milrinone_last,heparin_first,heparin_last,warfarin_first,warfarin_last
 )
```

# Exclusion criteria

```{r}
print('Initial number of patients')
exc_1<-nrow(final_df_order)
exc_1

final_df_selected <- final_df_order %>% filter(age > 16)
print('Underage patients excluded')
b<-nrow(final_df_selected)


print('Número final de pacientes')
nrow(final_df_selected)
```

## diagram
