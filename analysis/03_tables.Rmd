---
title: "03_tables"
output: html_document
---

# Environment
```{r}
library(tableone)
library(kableExtra)
library(knitr)
library(ggplot2)
library(ggdist)
library(diagram)
library(DiagrammeR)
```


# Table one
```{r}
# # Lists the variables we are going to be including in table1
vars_in_table1 <- names(final_df_selected %>% select(age,gender,apachescoreIV,apachedxgroup,prev_dept_los,prev_dept,albumin,bilirubin,BUN,calcium,creatinine,glucose,bicarbonate,TotalCO2,hematocrit,hemoglobin,INR,lactate,platelets,potassium,ptt,sodium,wbc,bands,alt,ast,alp,heartrate,respiratoryrate,spo2,nibp_systolic,nibp_diastolic,nibp_mean,temperature,ibp_systolic,ibp_diastolic,ibp_mean,norepinephrine_first, norepinephrine_last,epinephrine_first,epinephrine_last,dopamine_first,dopamine_last,dobutamine_first,dobutamine_last,phenylephrine_first,phenylephrine_last,vasopressin_first,vasopressin_last,milrinone_first,milrinone_last,heparin_first,heparin_last,warfarin_first,warfarin_last,icu_mortality_72hrs))

gender <- factor(final_df_selected$gender.x)
# Creates a dataset with only selected variables using our original dataset and generates an empty list for storing categorical variables
table1_dataset <- final_df_selected[,vars_in_table1]
cat_variables <- rep(NA, length(vars_in_table1))
stratifyby <- "icu_mortality_72hrs"

# Detects whether a variable is categorical or not
cont<-1
for (i in 1:length(vars_in_table1) ) {
  if ( n_distinct(table1_dataset[vars_in_table1[i] ]) <= 10 ) {
    print(i)
    print(vars_in_table1[i])
    print(names(table1_dataset[vars_in_table1[i]]))
    cat_variables[cont]<-names(table1_dataset[vars_in_table1[i]])
    cont<-cont+1
  }
}
cat_variables <- cat_variables[!is.na(cat_variables)]
table1_base <- print(CreateTableOne(vars = vars_in_table1
                                   , strata = stratifyby
                                  , factorVars = cat_variables
    ,data = table1_dataset, addOverall=T),varLabels = T)

# Run this in console for html output, the code below uses kableExtra::
starification_cats<-n_distinct(table1_dataset[,stratifyby])
 
# For console
table1_base %>%
   kbl(caption = "Table 1 of base model: Mortality 72 hours" , align = "c") %>%
   kable_classic_2(full_width = F, html_font = "Cambria") %>%
   add_header_above(c("", "", "No", "Yes", "", ""))
 
# Export kable
table1_base %>%
   kbl(caption = "Table 1 of base model: Mortality 72 hours" , align = "c") %>%
   kable_classic_2(full_width = F, html_font = "Cambria") %>%
   add_header_above(c("", "", "No", "Yes", "", "")) %>%
   save_kable("C:/Users/cjimenez10J/Documents/projects/eicu_mort_72h/figures/table1_base.html", zoom = 10)
```

#Creation of exclusion criteria diagram
```{r}
#Crea un lienzo vacío para el diagrama de flujo y definición de características globales para el gráfico que especifica la dirección de flujo de arriba a bajo
grViz("
      digraph {
      layout = neato;  // Cambia la disposición del grafo si lo deseas
      rankdir = TB;  // Establece la dirección de arriba a abajo
      }
    ")
#Agrego Nodos y conexiones (usa sintaxis DOT) 
graph <- grViz("
               digraph {
               layout = neato;
               rankdir = TB;
               A [label = 'Initial number of patients
               (n=200764)']
               
               B [label = 'EXCLUSION CRITERIA:
               Age < 16 years']
               
               C [label = 'Final number of patients
               (n=200468']
               
               A -> B
               B -> C
               }
               ")
graph
```



